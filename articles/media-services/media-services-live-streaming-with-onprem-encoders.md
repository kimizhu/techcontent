---
title: 使用本地编码器执行实时传送视频流以创建多比特率流 | Azure
description: 本主题介绍如何设置接收来自本地编码器的多比特率实时流的频道。然后，该流可以使用以下自适应流式处理协议之一通过一个或多个流式处理终结点传送给客户端播放应用程序：HLS、平滑流、MPEG DASH、HDS。
services: media-services
documentationCenter: 
authors: Juliako
manager: erikre
editor: 

ms.service: media-services
ms.workload: media
ms.tgt_pltfrm: na
ms.devlang: ne
ms.topic: article
ms.date: 10/12/2016
wacn.date: 12/26/2016
ms.author: cenkdin;juliako
---

#使用本地编码器执行实时传送视频流以创建多比特率流

##概述

在 Azure 媒体服务中，**频道**表示用于处理实时传送视频流内容的管道。**频道**采用以下两种方式之一接收实时输入流：

- 本地实时编码器将多比特率 **RTMP** 或“平滑流式处理”（分段 MP4）发送到未针对使用 AMS 执行实时编码而启用的频道。引入流将通过**频道**，但不会进行任何进一步处理。这种方法称为**直通**。可以使用以下输出多比特率平滑流的实时编码器：Elemental、Envivio、Cisco。以下实时编码器输出 RTMP：Adobe Flash Live、Telestream Wirecast 和 Tricaster 转码器。实时编码器也可将单比特率流发送到并未启用实时编码的通道，但不建议这样做。收到请求时，媒体服务会将该流传送给客户。

	>[!NOTE] 实时传送视频流时，使用直通方法是最经济的方式。
	
- 本地实时编码器（采用以下格式之一：RTP (MPEG-TS)、RTMP 或平滑流式处理（分段 MP4））将单比特率流发送到能够使用媒体服务执行实时编码的频道。然后，频道将对传入的单比特率流执行实时编码，使之转换为多比特率（自适应）视频流。收到请求时，媒体服务会将该流传送给客户。

从媒体服务2.10 发行版开始，创建通道时，可以指定希望通道接收输入流的方式，以及是否希望通道对流执行实时编码。可以使用两个选项：

- **无** - 如果计划使用输出多比特率流（直通流）的本地实时编码器，请指定此值。在这种情况下，传入流将传递到输出，而不会进行任何编码。这是 2.10 版本以前的频道行为。本主题提供了有关使用此类型的频道的详细信息。

- **标准** - 如果你打算使用媒体服务将单比特率实时流编码为多比特率流，请选择此值。请注意，实时编码会影响计费，应记住，将实时编码通道保持为“正在运行”状态会产生费用。建议在实时传送视频流事件完成之后立即停止正在运行的频道，以避免产生额外的小时费用。收到请求时，媒体服务会将该流传送给客户。

>[!NOTE]本主题讨论未针对执行实时编码（编码类型为**无**）而启用的频道的属性。有关使用为执行实时编码而启用的频道的信息，请参阅[使用 Azure 媒体服务进行实时传送视频流以创建多比特率流](./media-services-manage-live-encoder-enabled-channels.md)。

下图表示的是一个使用本地实时编码器输出多比特率 RTMP 或分段 MP4（平滑流式处理）流的实时传送视频流工作流。

![实时工作流][live-overview]  

本主题涵盖以下内容：

- [常见实时传送视频流方案](./media-services-live-streaming-with-onprem-encoders.md#scenario)
- [频道及其相关组件的说明](./media-services-live-streaming-with-onprem-encoders.md#channel)
- [注意事项](./media-services-live-streaming-with-onprem-encoders.md#Considerations)

##<a id="scenario"></a>常见实时传送视频流方案
以下步骤介绍创建常见的实时传送视频流应用程序时涉及的任务。

1. 将视频摄像机连接到计算机。启动并配置输出多比特率 RTMP 或分段 MP4（平滑流式处理）流的本地实时编码器。有关详细信息，请参阅 [Azure 媒体服务 RTMP 支持和实时编码器](https://azure.microsoft.com/zh-cn/blog/azure-media-services-rtmp-support-and-live-encoders/)。
	
	此步骤也可以在创建通道后执行。

1. 创建并启动通道。
1. 检索通道引入 URL。

	实时编码器使用引入 URL 将流发送到通道。
1. 检索通道预览 URL。

	使用此 URL 来验证通道是否正常接收实时流。

3. 创建节目。

	使用 Azure 经典管理门户时，创建节目的同时还会创建资产。

	使用 .NET SDK 或 REST 时，你需要创建一个资产并指定在创建节目时要使用该资产。
1. 发布与节目关联的资源。

	确保要从中以流形式传输内容的流式传输终结点上至少有一个串流保留单元。
1. 在准备好开始流式传输和存档时，启动节目。
2. （可选）可以向实时编码器发信号，以启动广告。将广告插入到输出流中。
1. 在要停止对事件进行流式传输和存档时，停止节目。
1. 删除节目（并选择性地删除资产）。

##<a id="channel"></a>频道及其相关组件的说明

###<a id="channel_input"></a>频道输入（引入）配置

####<a id="ingest_protocols"></a>引入流式处理协议

媒体服务支持使用以下流式处理协议引入的实时源：

- **多比特率分段 MP4**
 
- **多比特率 RTMP**

	当选择 **RTMP** 引入流式处理协议时，会为频道创建两个引入（输入）终结点：
	
	**主 URL**：指定频道的主 RTMP 引入终结点的完全限定 URL。

	**辅助 URL**（可选）：指定频道的辅助 RTMP 引入终结点的完全限定 URL。

	如果你想要提高引入流的持久性和容错性，并实现编码器故障转移和容错性（尤其在以下情况下），请使用辅助 URL。

	- 单个编码器双推送到主和辅助 URL：
	
		这样做的主要目的是为网络波动和抖动提供更多的复原能力。某些 RTMP 编码器无法良好处理网络断开连接情况。当出现网络断开连接时，编码器可能会停止编码，且在重新连接情况发生时，不再发送缓冲的数据，这将导致不连续性和数据丢失。网络断开连接可能是由错误的网络或 Azure 端的维护导致。主/辅助 URL 可减少网络问题，并且提供受控的升级过程。每当计划的网络发生断开连接情况时，媒体服务管理主要和次要断开连接并为两者提供延迟断开连接，从而使编码器有时间保留发送的数据并且再次重新连接。断开连接的顺序可以是随机的，但是在主要/次要或次要/主要之间将始终存在延迟。在此方案中，编码器仍是单点故障。
	 
	- 多个编码器中的每个编码器推送到专用的点：
		
		此方案提供编码器以及引入冗余。在此方案中编码器 1 推送到主 URL，而编码器 2 推送到辅助 URL。当一个编码器失败时，另一个编码器仍可以发送数据。由于媒体服务不会同时断开主要和次要连接，所以仍可保持数据冗余。此方案假定编码器为时间同步，并提供完全相同的数据。
 
	- 多个编码器双推送到主和辅助 URL：
	
		在此方案中这两个编码器将数据推送到主和辅助 URL。这提供了最佳的可靠性、容错能力以及数据冗余。它可以容忍两个编码器均失败，并且即使一个编码器停止工作时亦会断开连接。此方案假定编码器为时间同步，并提供完全相同的数据。

有关 RTMP 实时编码器的详细信息，请参阅 [Azure 媒体服务 RTMP 支持和实时编码器](https://azure.microsoft.com/zh-cn/blog/azure-media-services-rtmp-support-and-live-encoders/)。

请注意以下事项：

- 确保你有足够的空闲 Internet 连接将数据发送到引入点。
- 使用辅助引入 URL 需要额外的带宽。
- 传入多比特率流最多可包含 10 个视频质量级别（又称层）和最多为 5 个音频轨。
- 任何视频质量级别或层的最高平均比特率应低于 10 mbps。
- 所有视频和音频流的平均比特率聚合应小于 25 Mbps。
- 当频道或其关联的节目正在运行时，无法更改输入协议。如果你需要不同的协议，应当针对每个输入协议创建单独的频道。
- 你可引入单比特率至你的频道，但由于频道不处理流，客户端应用程序也会接收单比特率流（不建议使用此选项）。

####引入 URL（终结点） 

频道提供你在实时编码器中指定的输入终结点（引入 URL），因此编码器可以将流推送到你的频道。

当创建频道时，你可以获取引入 URL。若要获取这些 URL，频道不一定要处于“正在运行”状态。当准备好开始将数据推送到频道时，频道必须处于“正在运行”状态。在频道开始引入数据后，你可以通过预览 URL 预览流。

可以选择通过 SSL 连接引入分段 MP4（平滑流式处理）实时流。若要通过 SSL 进行引入，请确保将引入 URL 更新为 HTTPS。当前，无法通过 SSL 引入 RTMP。

####<a id="keyframe_interval"></a>关键帧间隔

当使用本地实时编码器生成多比特率流时，关键帧间隔指定 GOP 持续时间（与该外部编码器使用的相同）。当频道收到此传入流后，你可以通过下列任意格式将你的实时流传送到客户端播放应用程序：平滑流式处理、DASH 和 HLS。当执行实时传送视频流时，HLS 始终以动态方式打包。默认情况下，媒体服务根据从实时编码器收到的关键帧间隔（也称为图片组 – GOP）自动计算 HLS 段打包比率（每段的段数）。

下表显示了段持续时间的计算方式：

关键帧间隔|HLS 段打包比率 (FragmentsPerSegment)|示例
---|---|---
小于或等于 3 秒|3:1|如果 KeyFrameInterval（或 GOP）长度为 2 秒，则默认的 HLS 段打包比率将是 3:1，这将创建一个 6 秒的 HLS 段。
3 到 5 秒|2:1|如果 KeyFrameInterval（或 GOP）长度为 4 秒，则默认的 HLS 段打包比率将是 2:1，这将创建一个 8 秒的 HLS 段。
大于 5 秒|1:1|如果 KeyFrameInterval（或 GOP）长度为 6 秒，则默认的 HLS 段打包比率将是 1:1，这将创建一个 6 秒长的 HLS 段。

你可以通过配置频道的输出并设置 ChannelOutputHls 上的 FragmentsPerSegment，更改每段的段数这一比率。

你还可以通过设置 ChanneInput 上的 KeyFrameInterval 属性更改关键帧间隔值。

如果你显式设置 KeyFrameInterval，则会使用上面所述的规则计算 HLS 段打包比率 FragmentsPerSegment。

如果你同时显式设置 KeyFrameInterval 和 FragmentsPerSegment，则媒体服务将使用你设置的值。

####允许的 IP 地址

可以定义允许向此通道发布视频的 IP 地址。允许的 IP 地址可以指定为单个 IP 地址（例如“10.0.0.1”）、使用一个 IP 地址和 CIDR 子网掩码的 IP 范围（例如“10.0.0.1/22”），或使用一个 IP 地址和点分十进制子网掩码的 IP 范围（例如“10.0.0.1(255.255.252.0)”）。

如果未指定 IP 地址并且没有规则定义，则不会允许任何 IP 地址。若要允许任何 IP 地址，请创建一个规则并设置 0.0.0.0/0。

###通道预览 

####预览 URL

通道还提供了一个预览终结点（预览 URL），可使用它在进一步处理和传递流之前预览流并对其进行验证。

可在创建通道时获取预览 URL。若要获取该 URL，通道不一定要处于“正在运行”状态。

在频道开始引入数据后，你可以预览流。

请注意，当前不管指定了哪种输入类型，都只能以分段 MP4（平滑流式处理）格式传送预览流。你可以使用 [http://smf.cloudapp.net/healthmonitor](http://smf.cloudapp.net/healthmonitor) 播放器测试平滑流。你还可以使用 Azure 经典管理门户中承载的播放器查看你的流。

####允许的 IP 地址

可以定义允许连接到预览终结点的 IP 地址。如果未指定 IP 地址，则将允许任何 IP 地址。允许的 IP 地址可以指定为单个 IP 地址（例如“10.0.0.1”）、使用一个 IP 地址和 CIDR 子网掩码的 IP 范围（例如“10.0.0.1/22”），或使用一个 IP 地址和点分十进制子网掩码的 IP 范围（例如“10.0.0.1(255.255.252.0)”）。

###频道输出

有关详细信息，请参阅[设置关键帧间隔](#keyframe_interval)部分。

###频道的节目

通道与节目相关联，使用节目，可以控制实时流中片段的发布和存储。频道管理节目。频道和节目的关系非常类似于传统媒体，频道具有恒定的内容流，而节目的范围限定为该频道上的一些定时事件。

可以通过设置**存档时段**长度，指定你希望保留节目录制内容的小时数。此值的设置范围是最短 5 分钟，最长 25 小时。存储时段长度还决定了客户端能够从当前实时位置按时间向后搜索的最长时间。超出指定时间长度后，节目也能够运行，但落在时段长度后面的内容将全部被丢弃。此属性的值还决定了客户端清单能够增加多长时间。

每个节目都与存储流式处理内容的资源相关联。资产将映射到 Azure Storage 帐户中的 BLOB 容器，资产中的文件则作为该容器中的 BLOB 存储。若要发布节目，以便客户查看该流，必须为关联的资源创建按需定位符。创建此定位符后，你可以生成提供给客户端的流式处理 URL。

一个频道最多支持三个同时运行的节目，因此可为同一传入流创建多个存档。这样，你便可以根据需要发布和存档事件的不同部分。例如，你的业务要求是存档 6 小时的节目，但只广播过去 10 分钟的内容。若要实现此目的，需要创建两个同时运行的节目。一个节目设置为存档 6 小时的事件但不发布该节目。另一个节目设置为存档 10 分钟的事件，并且要发布该节目。

不应当将现有节目重用于新事件。而是应当为每个事件创建并启动一个新节目，如“对实时流式传输应用程序进行编程”部分中所述。

准备好开始流式传输和存档后，启动节目。要停止对事件进行流式传输和存档时，停止节目。

若要删除存档的内容，请停止并删除节目，然后删除关联的资产。如果资产被某个节目使用，则无法将其删除，必须先删除该节目。

即使停止并删除了节目，只要没有删除资产，用户也将能够按需将已存档的内容作为视频进行流式传输。

如果希望保留已存档的内容但不希望其可供流式传输，请删除流式传输定位符。

##<a id="states"></a>频道状态，以及状态如何映射到计费模式 

通道的当前状态。可能的值包括：

- **已停止**。这是通道在创建后的初始状态。此状态下可以更新通道属性，但不允许进行流式传输。
- **正在启动**。通道正在启动。此状态下不允许进行更新或流式传输。如果发生错误，通道会返回到“已停止”状态。
- **正在运行**。通道能够处理实时流。
- **正在停止**。通道正在停止。此状态下不允许进行更新或流式传输。
- **正在删除**。正在删除通道。此状态下不允许进行更新或流式传输。

下表显示通道状态如何映射到计费模式。
 
通道状态|门户 UI 指示器|是否计费？
---|---|---|---
正在启动|正在启动|否（暂时状态）
正在运行|准备就绪（没有正在运行的节目）<p>或<p>流式处理（至少有一个正在运行的节目）|是
正在停止|正在停止|否（暂时状态）
已停止|已停止|否

##<a id="cc_and_ads"></a>隐藏式字幕和广告插入 

下表展示了支持的隐藏式字幕和广告插入标准。

标准|说明
---|---
CEA-708 和 EIA-608 (708/608)|CEA-708 和 EIA-608 是美国和加拿大实施的隐藏式字幕标准。<p><p>当前，只有当编码的输入流中携带了该字幕时才支持该字幕。你需要使用能够向发送到媒体服务的编码流插入 608 或 708 字幕的实时媒体编码器。媒体服务会将带有插入的字幕的内容传送到你的查看器。
ismt 内的 TTML（平滑流式处理文本轨道）|媒体服务动态打包功能允许你的客户端对下列任何格式的内容进行流式传输：MPEG DASH、HLS 或平滑流式处理。不过，如果你引入 .ismt 内带有字幕（平滑流式处理文本轨道）的分段 MP4（平滑流式处理），则只能将该流传送到平滑流式处理客户端。
SCTE-35|用来提示广告插入的数字信号系统。下游接收器使用该信号将广告接合到流中并使其占用规定的时间。SCTE-35 必须在输入流中作为稀疏轨道发送。<p><p>请注意，当前唯一受支持的可以携带广告信号的输入流格式是分段 MP4（平滑流式处理）。唯一受支持的输出格式也是平滑流式处理。

##<a id="Considerations"></a>注意事项

当使用本地实时编码器将多比特率流发送到一个频道时，以下限制将适用：

- 确保你有足够的空闲 Internet 连接将数据发送到引入点。
- 传入多比特率流最多可包含 10 个视频质量级别（10 层）和最多 5 个音频轨。
- 任何视频质量级别或层的最高平均比特率应低于 10 Mbps
- 所有视频流和音频流的平均比特率聚合应小于 25 Mbps
- 当频道或其关联的节目正在运行时，无法更改输入协议。如果你需要不同的协议，应当针对每个输入协议创建单独的频道。

其他有关使用频道及其相关组件的注意事项：

- 每次重新配置实时编码器时，请对频道调用 **Reset** 方法。重置通道之前，必须停止节目。重置通道后，重新启动节目。
- 只有当通道处于“正在运行”状态且通道中的所有节目都已停止时才能停止通道。
- 默认情况下，你只能向你的媒体服务帐户添加 5 个频道。有关详细信息，请参阅[配额和限制](./media-services-quotas-and-limitations.md)。
- 通道或其关联的节目正在运行时，无法更改输入协议。如果需要不同的协议，应当针对每个输入协议创建单独的通道。
- 仅当通道处于“正在运行”状态时才会收取费用。有关详细信息，请参阅[此](./media-services-live-streaming-with-onprem-encoders.md#states)部分。

##如何创建从本地编码器接收多比特率实时流的频道

有关本地实时编码器的详细信息，请参阅[将第三方实时编码器与 Azure 媒体服务结合使用](https://azure.microsoft.com/blog/azure-media-services-rtmp-support-and-live-encoders/)。

依次选择“门户”、“.NET”、“REST API”，了解如何创建和管理频道和节目。

[!INCLUDE [media-services-selector-manage-channels](../../includes/media-services-selector-manage-channels.md)]

##相关主题

[Azure 媒体服务分段 MP4 实时引入规范](./media-services-fmp4-live-ingest-overview.md)

[使用 Azure 媒体服务传送实时传送视频流事件](./media-services-overview.md)

[媒体服务概念](./media-services-concepts.md)

[live-overview]: ./media/media-services-manage-channels-overview/media-services-live-streaming-current.png

<!---HONumber=Mooncake_Quality_Review_1215_2016-->